---
title: "DM"
---

# DEVOIR MAISON

::: {style="background-color: #ffccff;"}
J'attends vos rendus le **20/11/2023**. Les retards seront p√©nalis√©s (-2 points par semaine de retard)!

Vous pouvez me fournir **un rendu par groupe**

-   en m'indiquant (en quelques lignes) comment vous avez **r√©parti les t√¢ches** et de quelle mani√®re vous avez investi tel ou tel aspect
-   en m'indiquant si vous souhaitez avoir une **note commune** pour ce travail ou **une note individuelle**

Il faudra donc a minima que vous atteigniez un consensus sur cette partie "qui a fait quoi", et s'il y en a ne serait-ce qu'un seul qui souhaite la notation individualis√©e dans le groupe alors c'est son avis qui pr√©vaudra! (Oui c'est un peu compliqu√©: l'id√©e, comme vous l'aurez sans doute compris, c'est que personne ne se laisse passivement porter par les autres dans les groupes...)

J'attends que vous me fournissiez √† la fois:

-   le **document Rmarkdown** (qui, de fait, me permettra de voir l'int√©gralit√© des lignes de commande que vous aurez √©crit)
-   le **rapport "tricot√©"** (i.e. le fichier .doc, .html, ou .pdf selon vos pr√©f√©rences).

De ce fait, vous pouvez, si vous le souhaitez, ne pas me montrer les lignes de commandes dans le rapport pour faire "comme si" j'√©tais un interlocuteur qui ne conna√Æt pas le langage et s'int√©resse juste aux r√©sultats...

Si vous me montrez des tableaux de donn√©es interm√©diaires, essayez de me montrer seulement quelques lignes, ou leurs dimensions, pas des tableaux √©normes qui vont g√©n√©rer 10 pages de rapport pour pas grand chose...

Enfin, **ne soyez pas trop scolaires**... Prenez cet exercice comme une "simulation" de rapport qu'on vous demanderait de produire dans le cadre d'un stage ou de votre travail... Je veux dire par l√† que vous avez le droit d'utiliser des fonctions autres que celles que je vous ai montr√©es, de faire des choses en plus par rapport √† ce que je vous demande (pas en moins SVP :-p ), d'organiser le rapport pour que la progression soit la plus logique possible, etc. La description √©tape par √©tape que je vous indique n'est en effet l√† que pour vous aider dans votre progression (et pour assurer que vous r√©visiez bien diff√©rents aspects abord√©s dans le cours...), pas pour brimer votre imagination...
:::

Vous allez travailler sur des donn√©es de la **base Sirene de l'INSEE**, mise √† disposition sur [data.gouv.fr](data.gouv.fr), et qui r√©pertorie l'ensemble des **entreprises et √©tablissements actifs** en France. Les m√©tadonn√©es associ√©es √† cette base sont en partie d√©crites dans [ce tableau](https://www.data.gouv.fr/s/resources/base-sirene-des-entreprises-et-de-leurs-etablissements-siren-siret/20170112-180748/liste-modalites-l2.csv).

## Mise en place {#mise_en_place}

![](outlines/fig1.png){width="75%"}

### Installations, t√©l√©chargements, premiers tests sur le d√©partement 42

-   Si besoin, installez R et RStudio
-   **T√©l√©chargez** les donn√©es du **d√©partement 42**, `geo_siret_42.csv` [dans ce r√©pertoire](http://perso.ens-lyon.fr/lise.vaudor/Supports_formation/cours_geonum/data/geo-sirene/)
-   **T√©l√©chargez** la table qui renseigne les codes correspondant √† l'Activit√© Principale de l'Etablissement (APE)[APE_Type.csv](http://perso.ens-lyon.fr/lise.vaudor/Supports_formation/cours_geonum/data/APE_Type.csv)

### Lecture de tableaux de donn√©es {#manip_tableaux}

-   Depuis **RStudio**, **cr√©ez un projet** qui comprendra l'ensemble des donn√©es et documents n√©cessaires √† r√©aliser l'ensemble des traitements qui vous seront demand√©s pour ce TP.
-   **Cr√©ez le data.frame** `data42` en lisant la table `geo-siret_42.csv`.
-   Cr√©ez l'objet `APE_Type` en lisant le fichier relatif aux codes d'APE.

### Code et types d'activit√©s =\> commerces alimentaires

üëÅ Consultez [ce billet de blog sur la manipulation de cha√Ænes de caract√®res avec R et le package `stringr`](http://perso.ens-lyon.fr/lise.vaudor/manipuler-des-strings-avec-r/)

-   Combien d'entreprises ont un nom (enseigne1Etablissement) qui comprend le terme "BOULANGERIE"?
-   Ajoutez une variable `Code` √† votre table en ne conservant que les quatre premiers caract√®res de la variable activitePrincipaleEtablissement (cela correspond √† un **pattern "\^...."**, √† savoir le d√©but de cha√Æne de caract√®re suivi de quatre caract√®res quelconques -cf [ce billet de blog sur les expressions r√©guli√®res](http://perso.ens-lyon.fr/lise.vaudor/strings-et-expressions-regulieres/)-).
-   **Filtrez** les lignes de `data42` pour ne retenir que celles pour lesquelles l'APE correspond aux commerces "alimentaires" -alimentation, boisson, restaurant, bar- (voir la liste contenue dans le fichier APE_Type)
-   **Stockez** le r√©sultat de ces op√©rations dans un objet `alim42`.
-   üëÅ Allez jeter un coup d'oeil <a href="http://perso.ens-lyon.fr/lise.vaudor/combinaisons-et-jointures-de-tables-avec-dplyr/" target="_blank">ici</a> pour comprendre comment le principe et la r√©alisation des **jointures** √† l'aide du package `dplyr`.R√©alisez une **jointure** entre `data42_alim` (variable `codeAPE`) et `APE_Type` (variable `Code`), de mani√®re √† compl√©ter `alim42` avec les types de commerces (variables `Type` et `TypeAbreg`).

### R√©sum√©, classement

-   Quelles sont les **3 communes** de votre base de donn√©es qui comptent **le plus de magasins alimentaires**?
-   Pour les **communes qui ne comptent qu'un seul commerce** "alimentaire", de **quel type** est-il, le plus fr√©quemment?
-   Quelles **communes de plus de 100 commerces** comptent **au moins 10 commerces de type "viande"**?

## Rapport, statistiques descriptives

A ce stade, votre script commence √† √™tre un peu long et (peut-√™tre) un peu d√©sordonn√©... Ne serait-ce pas plus agr√©able de continuer votre projet sous la forme d'un **rapport Rmarkdown**? (Ne r√©pondez pas √† cette question, elle est rh√©torique...).

-   Cr√©ez un document `____.Rmd`, **structurez-le avec quelques titres**, et r√©partissez les diff√©rents morceaux de code de votre script de mani√®re pertinente dans diff√©rents **chunks**.
-   Vous pouvez maintenant r√©diger des paragraphes en y int√©grant des √©l√©ments de r√©ponses aux questions pos√©es pr√©c√©demment. R√©digez un **petit paragraphe** pour nommer les **3 communes qui comptent le plus d'entreprises** (exercice pr√©c√©dent) en utilisant l'insertion d'"**inline chunks**".

A partir de maintenant, votre **document de travail** sera un document\`\_\_\_.Rmd' et non le script que vous avez cr√©√© initialement...

## Programmation: automatisation pour plusieurs d√©partements {#program}

![](outlines/fig2.png){width="75%"}

### Fonction

Pour obtenir la table `alim42`, vous avez r√©alis√© un certain nombre d'op√©rations. On voudrait r√©aliser l'ensemble de ces op√©rations pour les 5 d√©partements suivants:

-   l'Ain (01)
-   l'Is√®re (38)
-   la Loire (42)
-   la Haute-Loire (43)
-   le Rh√¥ne (69)

R√©utilisez les commandes que vous avez mises au point sur data42 pour **√©crire une fonction** `get_clean_data()` qui r√©alisera l'ensemble de ces op√©rations sur le d√©partement de votre choix. L'input correspondra √† un **num√©ro de d√©partement** (c'est-√†-dire que vous pourrez utiliser la fonction en faisant, par exemple `get_clean_data("01")`).

üí¨ Pour lire le fichier, il faudra indiquer son **chemin**... Pensez √† r√©utiliser ce que vous venez d'apprendre sur les **cha√Ænes de caract√®res** pour reformer le chemin du fichier que vous int√©resse √† partir du num√©ro de d√©partement...

Certaines cha√Ænes de caract√®re sont interpr√©t√©es comme des cha√Ænes de caract√®re pour certains jeux de donn√©es (par exemple pour les codes postaux de l'Ain, √† cause du "0" en d√©but de cha√Æne) tandis qu'elle est interpr√©t√©e comme un num√©rique pour les autres jeux de donn√©es. Faites en sorte que votre fonction transforme bien cette variable pour qu'elles soient **toujours de classe "character"** en sortie (conversion par `as.character()`...).

### It√©ration

Appelez cette fonction **de mani√®re it√©rative pour chacun des d√©partements cit√©s ci-dessus**. Vous pouvez pour ce faire soit √©crire une boucle for, soit utiliser la fonction `map()` du package `purrr`.

-   A partir des 5 jeux de donn√©es obtenus vous cr√©erez **un seul et m√™me jeu de donn√©es `alimRA_entr`** (donn√©es pour l'ancienne r√©gion Rh√¥ne-Alpes, o√π 1 ligne=1 entreprise).

üí¨ Vous pourrez si vous le souhaitez vous servir de la commande `bind_rows()`.

Exemple:

```{r, echo=FALSE}
ma_liste=list(tibble::tibble(V1="pouet",V2=33, V3=0.22),
              tibble::tibble(V1="tut",V2=56, V3=0.18),
              tibble::tibble(V1="cot",V2=11, V3=0.16))
```

```{r, echo=TRUE, result=TRUE}
ma_liste
dplyr::bind_rows(ma_liste)
```

-   Rajoutez une variable `departement` (correspondant au num√©ro de d√©partement) √† votre jeu de donn√©es `alimRA_entr`. Peut-√™tre par des manipulations sur le code postal?...

### If et √©criture de fichier

Vous avez d√ª remarquer que l'ex√©cution de l'√©tape pr√©c√©dente prenait un peu de temps car les 5 fichiers geo-sirene lus sont tr√®s volumineux... En revanche la table `alimRA_entr` est de taille beaucoup plus raisonnable. Or, nous n'aurons besoin que de cette table pour la suite du projet. Pour √©viter d'ex√©cuter cette √©tape chronophage √† chaque fois que vous travaillerez sur ce projet:

-   **exportez** `alimRA_entr` dans un fichier `alimRA_entr.csv`.
-   entourez la boucle `for` d'une **structure conditionnelle `if`** de sorte que la boucle ne soit ex√©cut√©e que si le fichier `alimRA_entr.csv` n'existe pas (voir fonction `file.exists()`...)
-   √©crivez √† la suite la commande qui servira √† **lire `alimRA_entr.csv`** √† chaque "tricotage" de votre rapport Rmarkdown.

## R√©sum√© par commune et type de commerce

![](outlines/fig3.png){width="45%"}

### Agr√©gation des donn√©es par commune et type de commerce

Agr√©gez la table `alimRA_entr` par commune et type de commerce, pour cr√©er une table `alimRA_typeCom`(o√π une ligne correspondra √† un type de commerce pour une commune):

-   une variable `nInCom` correspondant au **nombre de commerces par commune**

-   une variable `nInTypeCom` correspondant au **nombre de commerces par type et commune**

-   une variable `propInTypeCom` correspondant √† la **proportion d'un type de commerce dans une commune**

-   Quelles communes comptant plus de 100 commerces comptes au moins 5% de commerces de type "viande"?

### Graphique

R√©alisez un graphique montrant les proportions des diff√©rents types de commerces pour **LYON 4EME** et **LYON 8EME**.

## Evolution dans le temps des cr√©ations d'entreprise

![](outlines/fig4.png){width="45%"}

### Manipuler des dates avec `lubridate`

Nous allons nous int√©resser aux dates de cr√©ation des entreprises de notre base `alimRA_entr` (variable `dateCreationEtablissement`).

üí¨ Pour le moment, `dateCreationEtablissement` est consid√©r√© comme une variable de type "cha√Æne de caract√®res". Pour faire comprendre √† R qu'il s'agit en r√©alit√© d'une date (et lui faire comprendre comment elle est mise en forme) nous allons faire appel au package `lubridate`.

üëÅ Consultez [ce billet de blog](http://perso.ens-lyon.fr/lise.vaudor/gerer-des-dates-avec-lubridate-un-jeu-denfant/) ou la [**vignette**](https://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html) du package `lubridate`, qui explique succintement comment utiliser ce package.

-   **Installez** et **chargez** le package `lubridate`.
-   Transformez le tableau `alimRA_entr` en **modifiant la classe de `dateCreationEtablissement`** √† l'aide d'une fonction de `lubridate`.
-   **Ajoutez une variable `annee`** au tableau `alimRA_entr` √† l'aide, √† nouveau, d'une des fonctions de `lubridate`.

### R√©sum√©, filtre

-   Cr√©ez une table `alimRA_typeAn` qui recense le \*\*nombre d'entreprises par ann√©e (`nInAn`), et par type\*ann√©e (`nInTypeAn`)\*\*.
-   **Filtrez** les donn√©es de `alimRA_typeAn` pour ne garder que les **entreprises dont la cr√©ation correspond aux ann√©es \>=1970**.

### Graphiques: √©volution du nombre d'entreprises au cours du temps

-   **Installez** et **chargez** le package `ggplot2`
-   R√©alisez un **graphique** repr√©sentant l'**√©volution des proportions d'entreprises (par type) par ann√©e**.
-   R√©alisez ce m√™me graphique, mais en repr√©sentant **le nombre de cr√©ations d'entreprises par ann√©e et par type, pour les 5 types comptant le plus de cr√©ations d'entreprises (au total)**.

## Cartes

![](outlines/fig5.png){width="45%"}

### Carte des boulangeries-p√¢tisseries

-   Repartez de la table `alim_entr` pour en faire un **objet de classe "sf"**. Vous vous servirez pour cela des colonnes "longitude" et "latitude" et exclurez les entreprises pour lesquelles ces colonnes ne sont pas renseign√©es.
-   R√©alisez une **carte** montrant le semis de points correspondant aux **boulangeries-p√¢tisseries**.
-   Essayez de repr√©senter √† travers cette carte l'ann√©e de cr√©ation de l'entreprise (de la mani√®re qui vous semblera la plus pertinente).

### Carte des proportions de commerce par commune

-   T√©l√©chargez le shapefile des limites de communes en France [ici](https://www.data.gouv.fr/fr/datasets/geofla-limites-des-communes-en-france/#_) et filtrez pour ne garder que les d√©partements consid√©r√©s ci-dessus.
-   Joignez aux communes les informations concernant les commerces (st_join()...) et calculez le nombre de commerces par commune.
-   Produisez une carte montrant le nombre de commerces par commune. Vous aurez sans doute √† retravailler l'√©chelle color√©e...
